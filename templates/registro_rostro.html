import cv2
import os
import face_recognition
import numpy as np

# Crear carpeta para almacenar los rostros si no existe
carpeta_rostros = 'rostros_registrados'
if not os.path.exists(carpeta_rostros):
    os.makedirs(carpeta_rostros)

print("=== Registro de Rostro ===")
nombre = input("Ingresa el nombre del usuario: ").strip()

if not nombre:
    print("âš ï¸  No ingresaste un nombre. Por favor, vuelve a intentarlo.")
    exit()

# Iniciar la cÃ¡mara
camara = cv2.VideoCapture(0)
if not camara.isOpened():
    print("âŒ No se pudo acceder a la cÃ¡mara. Verifica que estÃ© conectada.")
    exit()

print(f"\nğŸ“¸ Capturando imÃ¡genes para {nombre}...")
print("MantÃ©n el rostro centrado y presiona 'q' para finalizar.\n")

contador = 0
while True:
    ret, frame = camara.read()
    if not ret:
        print("âš ï¸ Error al capturar imagen.")
        break

    cv2.imshow("Registro de rostro - Presiona 'q' para salir", frame)

    # Guardar cada cierto nÃºmero de frames (por ejemplo, 1 de cada 5)
    if contador % 5 == 0:
        ruta_imagen = os.path.join(carpeta_rostros, f"{nombre}_{contador}.jpg")
        cv2.imwrite(ruta_imagen, frame)

    contador += 1

    # Salir con 'q'
    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

# Liberar la cÃ¡mara y cerrar ventanas
camara.release()
cv2.destroyAllWindows()

print(f"\nâœ… Se guardaron {contador // 5} imÃ¡genes del rostro de '{nombre}' en '{carpeta_rostros}'.")

# Codificar rostros y guardar como referencia
print("ğŸ” Procesando rostros...")

imagenes = []
nombres = []

for archivo in os.listdir(carpeta_rostros):
    if archivo.startswith(nombre):
        ruta = os.path.join(carpeta_rostros, archivo)
        imagen = face_recognition.load_image_file(ruta)
        codigos = face_recognition.face_encodings(imagen)

        if len(codigos) > 0:
            imagenes.append(codigos[0])
            nombres.append(nombre)

# Validar que se haya detectado al menos un rostro
if len(imagenes) == 0:
    print("âš ï¸ No se detectaron rostros vÃ¡lidos. Vuelve a intentarlo en mejor iluminaciÃ³n.")
    exit()

# Guardar los datos en archivos numpy
np.save(f"{carpeta_rostros}/codigos_{nombre}.npy", imagenes)
np.save(f"{carpeta_rostros}/nombres_{nombre}.npy", nombres)

print(f"âœ… Registro completado correctamente para el usuario '{nombre}'.")
print("ğŸš€ Los datos se han guardado exitosamente.\n")
